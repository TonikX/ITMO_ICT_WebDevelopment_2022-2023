# Лабораторная работа 3

## Структура проекта

- `LAB_WORK_3` - основная директория проекта
- `events_app` - приложение

## Настройки

- `settings.py`  

```python
"""
Django settings for LAB_WORK_3 project.

Generated by 'django-admin startproject' using Django 4.1.7.

For more information on this file, see
https://docs.djangoproject.com/en/4.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/4.1/ref/settings/
"""
import os
from pathlib import Path

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/4.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'django-insecure-fbf+7_)cwf-jth4s)iv*pe241^&0z-s(t@5nt=4r_uk4-3gbfp'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'events_app',
    'rest_framework',
    'rest_framework.authtoken',
    'djoser',
    'corsheaders',
    'drf_yasg'
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.common.CommonMiddleware"
]

ROOT_URLCONF = 'LAB_WORK_3.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [BASE_DIR / 'templates']
        ,
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'LAB_WORK_3.wsgi.application'


# Database
# https://docs.djangoproject.com/en/4.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.postgresql_psycopg2',
        'NAME': 'lab_3',
        'USER': 'admin',
        'PASSWORD': 'admin',
        'HOST': 'localhost',
        'PORT': '5432',
    }
}


# Password validation
# https://docs.djangoproject.com/en/4.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]

AUTH_USER_MODEL = "events_app.User"

CORS_ALLOW_METHODS = [
    "DELETE",
    "GET",
    "OPTIONS",
    "PATCH",
    "POST",
    "PUT",
]

CORS_ORIGIN_ALLOW_ALL = True

CORS_ALLOWED_ORIGINS = [
    "https://example.com",
    "https://sub.example.com",
    "http://localhost:5555",
    "http://127.0.0.1:5555",
    "http://localhost:8080"
]
# Internationalization
# https://docs.djangoproject.com/en/4.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/4.1/howto/static-files/

STATIC_URL = 'static/'

# Default primary key field type
# https://docs.djangoproject.com/en/4.1/ref/settings/#default-auto-field

DEFAULT_AUTO_FIELD = 'django.db.models.BigAutoField'

DJOSER = {
    'SEND_ACTIVATION_EMAIL': False,
    'SERIALIZERS': {
         'user_create': 'events_app.serializers.UserRegistrationSerializer'
    }
}
REST_FRAMEWORK = {
    'DEFAULT_AUTHENTICATION_CLASSES': (
        'rest_framework.authentication.TokenAuthentication',
    ),
}

MEDIA_ROOT = os.path.join(BASE_DIR, 'events_app/img/')
MEDIA_URL = 'img/'

```

- `LAB_WORK_3/urls.py`  



```python
from django.conf.urls.static import static
from django.contrib import admin
from django.urls import path, re_path, include
from drf_yasg.views import get_schema_view
from drf_yasg import openapi

from LAB_WORK_3 import settings

schema_view = get_schema_view(
   openapi.Info(
      title="API",
      default_version='v2',
      description="Description",
      terms_of_service="https://www.google.com/policies/terms/",
      contact=openapi.Contact(email="hardbeat34@gmail.com"),
      license=openapi.License(name="BSD License"),
   ),
   public=True,
)

urlpatterns = [
    path('admin/', admin.site.urls),
    path('api/', include('events_app.urls')),
    path('doc/swagger/', schema_view.with_ui('swagger', cache_timeout=0), name='schema-swagger-ui'),
    path('doc/redoc', schema_view.with_ui('redoc', cache_timeout=0), name='schema-redoc')
] + static(settings.MEDIA_URL, document_root=settings.MEDIA_ROOT)

```

## event_app

- `urls.py`

```python
from django.contrib import admin
from django.urls import path, re_path, include
from .views import *

urlpatterns = [
    path('auth/', include('djoser.urls')),
    re_path(r'^auth/', include('djoser.urls.authtoken')),

    path('users/<int:pk>', UserRetrieveAPIView.as_view()),
    path('users/update/<int:pk>', UserUpdateAPIView.as_view()),
    path('users/all', UserListAPIView.as_view()),
    path('user/new', UserCreateAPIView.as_view()),
    path('users/delete', UserDestroyAPIView.as_view()),

    path('categories/<int:pk>', CategoryRetrieveAPIView.as_view()),
    path('categories/all', CategoryListAPIView.as_view()),
    path('categories/new', CategoryCreateAPIView.as_view()),
    path('categories/delete', CategoryDestroyAPIView.as_view()),

    path('locations/<int:pk>', LocationRetrieveAPIView.as_view()),
    path('locations/update/<int:pk>', LocationUpdateAPIView.as_view()),
    path('locations/all', LocationListAPIView.as_view()),
    path('locations/new', LocationCreateAPIView.as_view()),
    path('locations/delete', LocationDestroyAPIView.as_view()),

    path('events/<int:pk>', EventRetrieveAPIView.as_view()),
    path('events/update/<int:pk>', EventUpdateAPIView.as_view()),
    path('events/all', EventListAPIView.as_view()),
    path('events/new', EventCreateAPIView.as_view()),
    path('events/delete', EventDestroyAPIView.as_view()),

    path('categories/<int:pk>', CategoryRetrieveAPIView.as_view()),
    path('categories/update/<int:pk>', CategoryUpdateAPIView.as_view()),
    path('categories/all', CategoryListAPIView.as_view()),
    path('categories/new', CategoryCreateAPIView.as_view()),
    path('categories/delete', CategoryDestroyAPIView.as_view()),

    path('enrollments/<int:pk>', UserEventEnrollmentRetrieveAPIView.as_view()),
    path('enrollments/all', UserEventEnrollmentListAPIView.as_view()),
    path('enrollments/new', UserEventEnrollmentCreateAPIView.as_view()),
    path('enrollments/<int:pk>/delete', UserEventEnrollmentDestroyAPIView.as_view())
]
```

- `models.py`
 
```python
import datetime

from django.contrib.auth.models import AbstractUser
from django.db import models


# Create your models here.

class User(AbstractUser):
    last_name = models.CharField(max_length=30)
    phone = models.BigIntegerField(default=79999999999, editable=True)
    user_image = models.ImageField(default="img/profile.png", upload_to="img")

    def __str__(self):
        return "{} {}".format(self.username, self.id, self.phone)


class Category(models.Model):
    name = models.CharField(max_length=30, unique=True)

    def __str__(self):
        return "{}".format(self.name)


class Location(models.Model):
    cities = [('Moscow', 'Москва'),
              ('Saint-Petersburg', 'Санкт-Петербург'),
              ('Kazan', 'Казань'),
              ('Tver', 'Тверь'),
              ('Vyborg', 'Выборг'),
              ('Kaliningrad', 'Калининград'),
              ('Sochi', 'Сочи')]
    city = models.CharField(max_length=20, choices=cities)
    street = models.CharField(max_length=40)
    max_count = models.IntegerField()
    place_name = models.CharField(max_length=40, default="none")

    def __str__(self):
        return "{}".format(self.place_name)


class Event(models.Model):
    organizer = models.CharField(max_length=100)
    category = models.ForeignKey(Category, on_delete=models.CASCADE)
    place = models.ForeignKey(Location, on_delete=models.CASCADE)
    about = models.CharField(max_length=2000)
    intro = models.CharField(max_length=500)
    date = models.DateField(default=datetime.date.today())
    time = models.TimeField(default=datetime.time.max)
    name = models.CharField(max_length=500, default='none')
    participants = models.ManyToManyField(User, through="UserEventEnrollment")

    def __str__(self):
        return "{}".format(self.name)


class UserEventEnrollment(models.Model):
    user = models.ForeignKey(User, on_delete=models.CASCADE)
    event = models.ForeignKey(Event, on_delete=models.CASCADE)

    def __str__(self):
        return "{}-{}".format(self.user, self.event)
```

- Исходный код сериализаторов `serializers.py`

```python
from rest_framework import serializers
from .models import *
from djoser.serializers import UserCreateSerializer as BaseUserRegistrationSerializer

class UserRegistrationSerializer(BaseUserRegistrationSerializer):
    class Meta(BaseUserRegistrationSerializer.Meta):
        fields = ('id','email', 'first_name', 'last_name', 'username', 'password', 'phone','user_image' )
class MyUserSerializer(serializers.ModelSerializer):
    class Meta:
        model = User
        fields = ['id', 'username', 'email', 'first_name', 'last_name', 'phone', 'user_image']

class CategorySerializer(serializers.ModelSerializer):
    class Meta:
        model = Category
        fields = '__all__'


class LocationSerializer(serializers.ModelSerializer):
    class Meta:
        model = Location
        fields = '__all__'


class EventSerializer(serializers.ModelSerializer):
    category = CategorySerializer()
    place = LocationSerializer()
    participants = MyUserSerializer(read_only=True, many=True)

    class Meta:
        model = Event
        fields = '__all__'


class UserEventEnrollmentSerializer(serializers.ModelSerializer):
    event = EventSerializer()
    class Meta:
        model = UserEventEnrollment
        fields = '__all__'

class UserEventEnrollmentCreateSerializer(serializers.ModelSerializer):
    class Meta:
        model = UserEventEnrollment
        fields='__all__'
```

- `views.py`:

```python
from django.shortcuts import render
from rest_framework import generics
from rest_framework.response import Response

from .models import *
from .serializers import *


# Create your views here.

class UserUpdateAPIView(generics.RetrieveUpdateAPIView):
    queryset = User.objects.all()
    serializer_class = MyUserSerializer


class UserCreateAPIView(generics.CreateAPIView):
    queryset = User.objects.all()
    serializer_class = MyUserSerializer


class UserListAPIView(generics.ListAPIView):
    queryset = User.objects.all()
    serializer_class = MyUserSerializer


class UserDestroyAPIView(generics.DestroyAPIView):
    queryset = User.objects.all()
    serializer_class = MyUserSerializer


class UserRetrieveAPIView(generics.RetrieveAPIView):
    queryset = User.objects.all()
    serializer_class = MyUserSerializer


class CategoryUpdateAPIView(generics.RetrieveUpdateAPIView):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer


class CategoryCreateAPIView(generics.CreateAPIView):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer


class CategoryListAPIView(generics.ListAPIView):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer


class CategoryDestroyAPIView(generics.DestroyAPIView):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer


class CategoryRetrieveAPIView(generics.RetrieveAPIView):
    queryset = Category.objects.all()
    serializer_class = CategorySerializer


class LocationUpdateAPIView(generics.RetrieveUpdateAPIView):
    queryset = Location.objects.all()
    serializer_class = LocationSerializer


class LocationCreateAPIView(generics.CreateAPIView):
    queryset = Location.objects.all()
    serializer_class = LocationSerializer


class LocationListAPIView(generics.ListAPIView):
    queryset = Location.objects.all()
    serializer_class = LocationSerializer


class LocationDestroyAPIView(generics.DestroyAPIView):
    queryset = Location.objects.all()
    serializer_class = LocationSerializer


class LocationRetrieveAPIView(generics.RetrieveAPIView):
    queryset = Location.objects.all()
    serializer_class = LocationSerializer


class EventUpdateAPIView(generics.RetrieveUpdateAPIView):
    queryset = Event.objects.all()
    serializer_class = EventSerializer


class EventCreateAPIView(generics.CreateAPIView):
    queryset = Event.objects.all()
    serializer_class = EventSerializer


class EventListAPIView(generics.ListAPIView):
    serializer_class = EventSerializer

    def get_queryset(self):
        queryset = Event.objects.all()
        parameters = self.request.query_params

        category = parameters.get('category', None)
        city = parameters.get('city', None)

        if category:
            queryset = queryset.filter(category=category)

        if city:
            queryset = queryset.filter(place__city=city)

        return queryset


class EventDestroyAPIView(generics.DestroyAPIView):
    queryset = Event.objects.all()
    serializer_class = EventSerializer


class EventRetrieveAPIView(generics.RetrieveAPIView):
    queryset = Event.objects.all()
    serializer_class = EventSerializer


class UserEventEnrollmentUpdateAPIView(generics.RetrieveUpdateAPIView):
    queryset = UserEventEnrollment.objects.all()
    serializer_class = UserEventEnrollmentSerializer


class UserEventEnrollmentCreateAPIView(generics.CreateAPIView):
    queryset = UserEventEnrollment.objects.all()
    serializer_class = UserEventEnrollmentCreateSerializer
    def create(self, request, *args, **kwargs):

        enrollment_data = self.request.data

        enrollment = UserEventEnrollment.objects.filter(user_id=enrollment_data['user'],
                                        event_id=enrollment_data['event'])

        if enrollment:
            return Response({'err':'enrollment already exist'})

        else:
            user = User.objects.get(id=enrollment_data['user'])
            event = Event.objects.get(id=enrollment_data['event'])

            new_enrollment = UserEventEnrollment.objects.create(user=user,
                                                                event=event)
            new_enrollment.save()
            serializer = UserEventEnrollmentSerializer(new_enrollment)

            return Response(serializer.data, status=201)


class UserEventEnrollmentListAPIView(generics.ListAPIView):
    serializer_class = UserEventEnrollmentSerializer


    def get_queryset(self):
        queryset = UserEventEnrollment.objects.all()

        parameters = self.request.query_params

        user_id = parameters.get('user_id')

        if user_id:
            queryset = queryset.filter(user_id=user_id)

        return queryset


class UserEventEnrollmentDestroyAPIView(generics.DestroyAPIView):
    queryset = UserEventEnrollment.objects.all()
    serializer_class = UserEventEnrollmentSerializer


class UserEventEnrollmentRetrieveAPIView(generics.RetrieveAPIView):
    queryset =UserEventEnrollment.objects.all()
    serializer_class = UserEventEnrollmentSerializer




```