#Лабораторная работа №2 - Реализация простого сайта на django
##Цель
* дать краткое представление о работе Django WEB фреймворка.
* Необходимо реализовать следующий функционал:
* Регистрация новых пользователей.
* Просмотр автогонок и регистрацию гонщиков. Пользователь должен иметь
возможность редактирования и удаления своих регистраций.
* Написание отзывов и комментариев к автогонкам. Предварительно
комментатор должен зарегистрироваться. При добавлении комментариев
должны сохраняться даты заезда, текст комментария, тип комментария
(вопрос о сотрудничестве, вопрос о гонках, иное), рейтинг (1-10),
информация о комментаторе.
* Администратор должен иметь возможность указания времени заезда и
результата средствами Django-admin.
* В клиентской части должна формироваться таблица всех заездов и
результатов конкретной гонки.

* `models.py`
```python
from django.db import models
from datetime import datetime
import django
from django.contrib.auth.models import User

class Driver(models.Model):
	COUNTRIES = (
		('ES', 'Spain'),
		('IT', 'Italy'),
		('FR', 'France'),
		('DE', 'Deutschland'))

	RACER_TYPES = (
		('Drag', 'Drag racer'),
		('Sport', 'Sports car racer'),
		('Off', 'Off-road racer'))
	user = models.OneToOneField(User, null=True, on_delete=models.CASCADE)
	name = models.CharField(max_length=200, null=True)
	surname = models.CharField(max_length=200, null=True)
	team = models.CharField(max_length=200, null=True)
	country = models.CharField(max_length=2, choices=COUNTRIES, null=True)
	driver_class = models.CharField(max_length=5, choices=RACER_TYPES, null=True)
	age = models.IntegerField(null=True)
	experience = models.IntegerField(null=True)

	def __str__(self):
		return '{} {}'.format(self.name, self.surname)

class Car(models.Model):
	CAR_TYPES = (
		('Drag', 'Drag'),
		('Sport', 'Sportscar'),
		('Off', 'Off-road'))
	car_model = models.CharField(max_length=200, null=True)
	number = models.IntegerField(null=True, unique=True)
	car_class = models.CharField(max_length=200, choices=CAR_TYPES, null=True)
	speed = models.IntegerField(null=True)
	weight = models.FloatField(null=True)
	length = models.FloatField(null=True)
	mileage = models.IntegerField(null=True)
	driver = models.ForeignKey(Driver, null=True, on_delete=models.SET_NULL)

	def __str__(self):
		return '{} {}'.format(self.car_model, self.number)

class Race(models.Model):
	RACE_TYPES = (
		('Drag', 'Drag racing'),
		('Sport', 'Sports car racing'),
		('Off', 'Off-road racing'))
	race_date = models.DateField(null=True)
	race_type = models.CharField(max_length=200, choices=RACE_TYPES, null=True)
	length = models.IntegerField(null=True)
	name = models.CharField(max_length=200, null=True)
	registrations = models.ManyToManyField(Driver, through='Registration', blank=True)
	time = models.TimeField(null=True, blank=True)

	def __str__(self):
		return '{} - {}'.format(self.name, self.id)


class Comment(models.Model):
	TYPE = (
		('Cooperation', 'Cooperation'),
		('Race', 'Race'),
		('Other', 'Other'))
	RATE = (
		('1', '1'),
		('2', '2'),
		('3', '3'),
		('4', '4'),
		('5', '5'))
	race = models.ForeignKey(Race, null=True, on_delete=models.SET_NULL)
	driver = models.ForeignKey(Driver, null=True, on_delete=models.SET_NULL)
	text = models.TextField()
	com_type = models.CharField(max_length=11, choices=TYPE, null=True)
	grade = models.CharField(max_length=1, choices=RATE, null=True)
	def __str__(self):
		return '{}: {}'.format(self.driver, self.com_type)


class Registration(models.Model):
	race = models.ForeignKey(Race, null=True, on_delete=models.SET_NULL)
	driver = models.ForeignKey(Driver, null=True, on_delete=models.SET_NULL)
	reg_date = models.DateField(null=True, blank=True, default = django.utils.timezone.now)
	place = models.IntegerField(null=True, blank=True)
	car = models.ForeignKey(Car, null=True, on_delete=models.SET_NULL)

	def __str__(self):
		return '{} {}'.format(self.race, self.driver)
```

* `settings.py`
```python
"""
Django settings for races_project project.

Generated by 'django-admin startproject' using Django 3.1.1.

For more information on this file, see
https://docs.djangoproject.com/en/3.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.1/ref/settings/
"""

from pathlib import Path
import os

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = '$mg+gogaa2)hng#pw&@4s46@e1#sr-aks-1_vbr!9iqkri_p1x'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'races.apps.RacesConfig',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'races_project.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'races_project.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': os.path.join(BASE_DIR, 'db.sqlite3'),
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.1/howto/static-files/

STATIC_URL = '/static/'
```

* `forms.py`
```python
from django.forms import ModelForm
from .models import Registration, Car, Driver, Comment, Race
from django.contrib.auth.forms import UserCreationForm
from django import forms
from django.contrib.auth.models import User


class RegForm(ModelForm):
    class Meta:
        model = Registration
        fields = '__all__'


class CarForm(ModelForm):
    class Meta:
        model = Car
        fields = ['car_model', 'number', 'car_class', 'speed', 'weight', 'length', 'mileage']


class CreateUserForm(UserCreationForm):
    class Meta:
        model = User
        fields = ['username', 'email', 'password1', 'password2']


class CreateDriverForm(ModelForm):
    class Meta:
        model = Driver
        fields = ['name', 'surname', 'team', 'country', 'driver_class', 'age', 'experience']


class CommentForm(ModelForm):
    class Meta:
        model = Comment
        fields = '__all__'


class RaceForm(ModelForm):
    class Meta:
        model = Race
        fields = '__all__'
```

* `urls.py`
```python
from django.contrib import admin
from django.urls import path
from django.http import HttpResponse
from . import views


urlpatterns = [
    path('', views.races),
    path('races/<int:pk_test>/drivers', views.drivers, name="race"),
    path('races/', views.races, name="races"),
    path('home/', views.home, name="home"),
    path('registration/create', views.createReg, name="registration_cr"),
    path('registration/<int:pk>/change', views.changeReg, name="registration_ch"),
    path('registration/<int:pk>/delete', views.deleteReg, name="registration_dl"),
    path('car/create', views.createCar, name="car_cr"),
    path('car/<int:pk>/change', views.changeCar, name="car_ch"),
    path('register', views.regPage, name="register"),
    path('login', views.loginPage, name="login"),
    path('logout', views.logoutUser, name="logout"),
    path('driver_cr', views.regDriver, name="driver_cr"),
    path('race/<int:pk>/registrate', views.raceReg, name="race_reg"),
    path('race/<int:pk>/comment', views.writeComment, name="comment"),
    path('race/create', views.createRace, name="race_cr"),
    path('race/<int:pk>/change', views.changeRace, name="race_ch"),
    path('race/<int:pk>/results', views.results, name="results"),
    path('race/<int:pk>/comments', views.comments, name="comments"),
    path('race/<int:pk>/delete', views.delRace, name="race_dl"),
]
```

* `views.py`
```python
from django.shortcuts import render, redirect
from django.http import HttpResponse
from .models import *
from .forms import *
from django.contrib import messages
from django.contrib.auth import authenticate, login, logout
from django.contrib.auth.decorators import login_required
from .decorators import unauthenticated_user, allowed_users
from django.contrib.auth.models import Group
from django.forms import inlineformset_factory


@unauthenticated_user
def regPage(request):
    form = CreateUserForm()
    if request.method == "POST":
        form = CreateUserForm(request.POST)
        if form.is_valid():
            user = form.save()

            group = Group.objects.get(name='driver')
            user.groups.add(group)
            Driver.objects.create(user=user)

            messages.success(request, 'Account was created')
            return redirect('driver_cr')

    context = {'form': form}
    return render(request, 'reg_user.html', context)


@unauthenticated_user
def loginPage(request):
    if request.method == "POST":
        username = request.POST.get('username')
        password = request.POST.get('password')

        user = authenticate(request, username=username, password=password)

        if user is not None:
            login(request, user)
            return redirect('/races')
        else:
            messages.info(request, 'Username or password is not correct')

    context = {}
    return render(request, 'login_page.html', context)


def logoutUser(request):
    logout(request)
    return redirect('/login')


@login_required(login_url='login')
@allowed_users(allowed_roles=['driver'])
def home(request):
    regs = request.user.driver.registration_set.all()
    driver = Driver.objects.get(id=request.user.driver.id)
    # cars = request.user.driver.car_set.all()
    cars = Car.objects.filter(driver=Driver.objects.get(id=request.user.driver.id))

    return render(request, 'home.html', {'regs': regs, 'cars': cars, 'driver': driver})


@login_required(login_url='login')
def drivers(request, pk_test):
    drivers = []
    cars = []

    registrations = Registration.objects.filter(race=pk_test).order_by('place')
    for reg in registrations:
        drivers.append(reg.driver)
        cars.append(reg.car)
    print(drivers)

    return render(request, 'drivers.html', {'drivers': drivers, 'cars': cars, 'regs': registrations})


@login_required(login_url='login')
def races(request):
    context = Race.objects.all()
    return render(request, 'races.html', {'races': context})


@login_required(login_url='login')
def createReg(request):
    driver = Driver.objects.get(id=request.user.driver.id)
    car = Car.objects.get(driver=driver)

    # if Registration.objects.get(driver=driver, race=race):
    # 	messages.error(request, 'You are already regestered to this race')
    # 	return redirect('/home')

    if car.car_model == None:
        messages.error(request, 'You need a car to register')
        return redirect('/home')

    form = RegForm(initial={'driver': driver, 'car': car})
    if request.method == "POST":
        print(request.POST)
        form = RegForm(request.POST)
        race_test = Race.objects.get(id=request.POST.get('race'))
        if Registration.objects.filter(driver=driver, race=race_test):
            messages.error(request, 'You are already regestered to this race')
            return redirect('/home')
        if form.is_valid():
            reg = form.save()
            return redirect('/home')
            messages.success(request, 'You were registered')

    context = {'form': form}
    return render(request, 'reg_form.html', context)


@login_required(login_url='login')
def raceReg(request, pk):
    driver = Driver.objects.get(id=request.user.driver.id)
    race = Race.objects.get(id=pk)
    if Registration.objects.filter(driver=driver, race=race):
        messages.error(request, 'You are already regestered to this race')
    else:
        car = Car.objects.get(driver=driver)
        if car.car_model != None:
            Registration.objects.create(driver=driver, race=race, car=car)
            messages.success(request, 'You were registered')
        else:
            messages.error(request, 'You need a car to register')

    return redirect('/races')


@login_required(login_url='login')
def changeReg(request, pk):
    reg = Registration.objects.get(id=pk)
    form = RegForm(instance=reg)
    if request.method == "POST":
        form = RegForm(request.POST, instance=reg)
        if form.is_valid():
            form.save()
            return redirect('/home')
    context = {'form': form}
    return render(request, 'reg_form.html', context)


def regDriver(request):
    driver = Driver.objects.get(name=None)
    form = CreateDriverForm(instance=driver)
    if request.method == "POST":
        form = CreateDriverForm(request.POST, instance=driver)
        if form.is_valid():
            driver = form.save()
            Car.objects.create(driver=driver)
            messages.success(request, 'Driver was created')
            return redirect('login')

    context = {'form': form}
    return render(request, 'reg_driver.html', context)


@login_required(login_url='login')
def deleteReg(request, pk):
    reg = Registration.objects.get(id=pk)
    context = {'reg': reg}
    if request.method == "POST":
        reg.delete()
        return redirect('/home')

    return render(request, 'del_reg.html', context)


@login_required(login_url='login')
def createCar(request):
    driver = Driver.objects.get(id=request.user.driver.id)
    car = Car.objects.get(driver=driver)
    form = CarForm(instance=car)

    if request.method == "POST":
        form = CarForm(request.POST, instance=car)
        if form.is_valid():
            car = form.save()
            return redirect('/home')

    context = {'form': form}

    return render(request, 'carForm.html', context)


@login_required(login_url='login')
def changeCar(request, pk):
    car = Car.objects.get(id=pk)
    form = CarForm(instance=car)

    if request.method == "POST":
        form = CarForm(request.POST, instance=car)
        if form.is_valid():
            form.save()
            return redirect('/home')

    context = {'form': form}
    return render(request, 'carForm.html', context)


@login_required(login_url='login')
def writeComment(request, pk):
    race = Race.objects.get(id=pk)
    driver = Driver.objects.get(id=request.user.driver.id)
    form = CommentForm(initial={'race': race, 'driver': driver})

    if request.method == 'POST':
        form = CommentForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'You left a comment for admin. Wait for an answer')
            return redirect('/races')

    context = {'form': form}
    return render(request, 'comment_form.html', context)


@login_required(login_url='login')
def createRace(request):
    form = RaceForm()
    if request.method == "POST":
        form = RaceForm(request.POST)
        if form.is_valid():
            form.save()
            messages.success(request, 'Race was created')
            return redirect('/races')

    context = {'form': form}
    return render(request, 'race_form.html', context)


@login_required(login_url='login')
def changeRace(request, pk):
    race = Race.objects.get(id=pk)
    form = RaceForm(instance=race)

    if request.method == "POST":
        form = RaceForm(request.POST, instance=race)
        if form.is_valid():
            form.save()
            return redirect('/races')

    context = {'form': form}
    return render(request, 'race_form.html', context)


@login_required(login_url='login')
def results(request, pk):
    raceFormSet = inlineformset_factory(Race, Registration, fields=('driver', 'place'), extra=0)
    race = Race.objects.get(id=pk)
    regs = race.registration_set.count()
    formset = raceFormSet(instance=race)
    if request.method == 'POST':
        formset = raceFormSet(request.POST, instance=race)
        if formset.is_valid():
            formset.save()
            return redirect('/races')

    context = {'formset': formset, 'regs': regs}
    return render(request, 'race_res.html', context)


@login_required(login_url='login')
def comments(request, pk):
    race = Race.objects.get(id=pk)
    comments = race.comment_set.all()
    context = {'comments': comments}

    return render(request, 'comments.html', context)


@login_required(login_url='login')
def delRace(request, pk):
    race = Race.objects.get(id=pk)
    context = {'race': race}
    if request.method == "POST":
        race.delete()
        return redirect('/races')

    return render(request, 'del_race.html', context)
```


##Практическая 2.1
* Цель работы: дать краткое представление о работе Django WEB фреймворка.
* `models.py`
```python
from django.db import models


class Car(models.Model):
    brand = models.CharField(max_length=50)
    model = models.CharField(max_length=50)
    color = models.CharField(max_length=30)
    plate_number = models.CharField(max_length=20)


class Owner(models.Model):
    first_name = models.CharField(max_length=50)
    last_name = models.CharField(max_length=50)
    date_of_birth = models.DateField()


class OwnedCars(models.Model):
    owner = models.ForeignKey(Owner, on_delete=models.CASCADE)
    car = models.ForeignKey(Car, on_delete=models.CASCADE)
    start_date = models.DateField()
    end_date = models.DateField()


class DrivingLicense(models.Model):
    TYPES = (
        ('M', 'Quadrocycles'),
        ('A', 'Motorcycles'),
        ('B', 'Car'),
        ('C', 'Light Trucks'),
        ('E', 'Trailers')
    )
    id_number = models.CharField(max_length=30)
    date_of_giving = models.DateField()
    category = models.CharField(max_length=5, choices=TYPES)
    owner = models.ForeignKey(Owner, on_delete=models.CASCADE)

```

* `views.py`
```python
from django.shortcuts import render
from django.http import Http404
from project_first_app.models import Owner


def index(request, owner_id):
    try:
        owner = Owner.objects.get(pk=owner_id)
    except Owner.DoesNotExist:
        raise Http404('Owner does not exist')

    return render(request, 'index.html', {"Owner": owner})

```
* `settings.py`
```python
"""
Django settings for django_project project.

Generated by 'django-admin startproject' using Django 3.1.3.

For more information on this file, see
https://docs.djangoproject.com/en/3.1/topics/settings/

For the full list of settings and their values, see
https://docs.djangoproject.com/en/3.1/ref/settings/
"""

from pathlib import Path
import os

# Build paths inside the project like this: BASE_DIR / 'subdir'.
BASE_DIR = Path(__file__).resolve().parent.parent


# Quick-start development settings - unsuitable for production
# See https://docs.djangoproject.com/en/3.1/howto/deployment/checklist/

# SECURITY WARNING: keep the secret key used in production secret!
SECRET_KEY = 'ay#y*b9-o%1&*qxd5hlfwtnq4y_6$vk=*u$5=j@5g*ey#gf^_1'

# SECURITY WARNING: don't run with debug turned on in production!
DEBUG = True

ALLOWED_HOSTS = []


# Application definition

INSTALLED_APPS = [
    'django.contrib.admin',
    'django.contrib.auth',
    'django.contrib.contenttypes',
    'django.contrib.sessions',
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'project_first_app',
]

MIDDLEWARE = [
    'django.middleware.security.SecurityMiddleware',
    'django.contrib.sessions.middleware.SessionMiddleware',
    'django.middleware.common.CommonMiddleware',
    'django.middleware.csrf.CsrfViewMiddleware',
    'django.contrib.auth.middleware.AuthenticationMiddleware',
    'django.contrib.messages.middleware.MessageMiddleware',
    'django.middleware.clickjacking.XFrameOptionsMiddleware',
]

ROOT_URLCONF = 'django_project.urls'

TEMPLATES = [
    {
        'BACKEND': 'django.template.backends.django.DjangoTemplates',
        'DIRS': [os.path.join(BASE_DIR, 'templates')],
        'APP_DIRS': True,
        'OPTIONS': {
            'context_processors': [
                'django.template.context_processors.debug',
                'django.template.context_processors.request',
                'django.contrib.auth.context_processors.auth',
                'django.contrib.messages.context_processors.messages',
            ],
        },
    },
]

WSGI_APPLICATION = 'django_project.wsgi.application'


# Database
# https://docs.djangoproject.com/en/3.1/ref/settings/#databases

DATABASES = {
    'default': {
        'ENGINE': 'django.db.backends.sqlite3',
        'NAME': BASE_DIR / 'db.sqlite3',
    }
}


# Password validation
# https://docs.djangoproject.com/en/3.1/ref/settings/#auth-password-validators

AUTH_PASSWORD_VALIDATORS = [
    {
        'NAME': 'django.contrib.auth.password_validation.UserAttributeSimilarityValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.MinimumLengthValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.CommonPasswordValidator',
    },
    {
        'NAME': 'django.contrib.auth.password_validation.NumericPasswordValidator',
    },
]


# Internationalization
# https://docs.djangoproject.com/en/3.1/topics/i18n/

LANGUAGE_CODE = 'en-us'

TIME_ZONE = 'UTC'

USE_I18N = True

USE_L10N = True

USE_TZ = True


# Static files (CSS, JavaScript, Images)
# https://docs.djangoproject.com/en/3.1/howto/static-files/

STATIC_URL = '/static/'

```

* `urls.py`
```python
"""django_project URL Configuration

The `urlpatterns` list routes URLs to views. For more information please see:
    https://docs.djangoproject.com/en/3.1/topics/http/urls/
Examples:
Function views
    1. Add an import:  from my_app import views
    2. Add a URL to urlpatterns:  path('', views.home, name='home')
Class-based views
    1. Add an import:  from other_app.views import Home
    2. Add a URL to urlpatterns:  path('', Home.as_view(), name='home')
Including another URLconf
    1. Import the include() function: from django.urls import include, path
    2. Add a URL to urlpatterns:  path('blog/', include('blog.urls'))
"""
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path('admin/', admin.site.urls),
    path('', include('project_first_app.urls')),
]

```
